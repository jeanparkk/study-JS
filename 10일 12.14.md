# node.js,mongoDB 3-16 • 유저간 채팅기능 만들기 1. 채팅방 만들기

**0:00 댓글기능/채팅기능 만드는 법**

**6:25 오늘의 숙제1**

**9:26 오늘의 숙제2**

이번엔 채팅기능을 만들어볼 것입니다.

**근데 웹상의 거의 모든 기능들은 그냥 게시물 발행과 구현방법이 똑같습니다.**

그래서 제가 계속 님들 배울거 다 배웠다고 하는 것임

Q. 회원가입기능 어떻게 만들어요?

A. 게시물 발행기능과 똑같습니다. 근데 거기에 회원 아이디 비번이 기록될 뿐

Q. 상품 무통장입금 주문기능 어떻게 만들어요?

A. 게시물 발행기능과 똑같습니다. 근데 거기에 주문자아이디, 상품명, 가격, 날짜가 들어가있을 뿐

Q. 채팅메세지는요?

A. 채팅메세지도 게시물 발행기능과 똑같습니다. 근데 카톡처럼 메세지 내용, 보낸사람, 날짜 등이 기록될 뿐입니다.

근데 하나 새로운 점이 있는데 채팅메세지는 **채팅방 게시물에 종속되어야합니다.**

이해를 돕기 위해 채팅과 비슷한 **게시물 + 댓글만드는 법**을 잠깐 배워봅시다.

**댓글을 어떻게 만드냐면**

게시물에 댓글기능을 추가하고 싶습니까.

그러면 댓글 게시물 발행기능을 추가하면 됩니다.

그냥 댓글 collection 하나 새로 만들어서 모든 댓글을 저장하면 됩니다.

![https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC1.png](https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC1.png)

▲ 근데 collection안에 대충 전부 집어넣어버리면 대체 무슨 글에 달린 댓글인지 구분이 안되겠죠?

잘 생각해보면 댓글들은 **부모 게시물**이 존재합니다.

모든 댓글은 부모 게시물에 달려있어야하니까요.

그것까지 기록해놔야 나중에 댓글을 불러올 때 내가 원하는 댓글만 불러올 수 있을텐데

댓글을 저장할 때 부모 게시물정보도 함께 저장하면 문제 해결일듯요

![https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC2.png](https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC2.png)

왼쪽 collection은 원래 개발해놨던 할일리스트 게시물들입니다.

오른쪽 collection에 댓글 게시물을 기록할 땐 어떤 할일 게시물에 속하는지도 함께 기록하는겁니다.

그러면 나중에 게시물A의 댓글만 불러오고싶을 때 "{ 부모 : '게시물A' } 가진 댓글만 가져와주세요~" 라고 query를 줄 수도 있겠네요.

이렇게 해놓으면 댓글기능 개발 끝일듯요

부모를 기록하는 작업을 전문용어로 **"컬렉션끼리 관계를 맺는다~"** 라고 합니다.

어떤 **게시물에 종속된 게시물이 필요할 때** 저런 식으로 관계를 지정해보십시오.

**채팅기능은 어떻게 만드냐면**

위에서 설명한 게시물 + 댓글이랑 똑같습니다.

카톡보시면 카톡은 일단 채팅하고 싶으면 채팅방을 고르죠?

채팅방 누르면 댓글들이 쭉 나옵니다.

그래서 그냥 글작성 + 댓글이랑 똑같은 기능입니다. (나중에 실시간업데이트 기능만 추가될 뿐임)

지칭하는 이름만 채팅방 + 메세지로 바꾸면 됩니다.

![https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC3.png](https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC3.png)

이런 식으로 디자인하면 이쁘겠군요.

아무튼 선생 코드 아무 생각없이 따라치면 타자실력만 늘테니

혼자서도 코드 잘 짜고 싶으시면

1. 모든 기능은 게시물 발행이랑 똑같다

2. 종속관계가 필요하면 관계를 맺으면 된다

이것만 있으면 이제 정말 혼자서도 대부분의 기능 개발할 수 있습니다.

**Q. 채팅메세지 이렇게 저장하면 쉽지 않나요?**

메세지를 채팅방 게시물의 필드하나에 다 밀어넣는겁니다.

![https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC4.png](https://codingapple.com/wp-content/uploads/2021/10/%EA%B7%B8%EB%A6%BC4.png)

▲이것도 가능합니다. 근데 하나의 document는 16MB 용량제한이 있어서

갯수가 많으면 하나의 게시물로 빼서 다루는게 좋습니다. 그게 나중에 수정삭제도 쉬움

데이터 갯수가 적고 변동이 적으면 저렇게 저장하는 것도 나쁘지 않습니다.

**채팅방 만들기**

채팅방 게시물이 있어야

그 밑에 댓글들을 (메세지들을) 쭉 기록할거 아닙니까.

우선 채팅방을 만들어보도록 합시다.

DB에 뭐 저장하는건 맨날 하던거라 그냥 숙제로 해오도록 합시다.

**(숙제1) /list페이지 글 옆의 버튼을 누르면 채팅방 게시물을 발행해보십시오.**

답보고 싶어서 손이 덜덜 떨린다면 개쉬운 가이드를 드리겠습니다.

1. /list 페이지에 있는 게시물들 옆에 '이 유저와 채팅하기' 버튼을 아무데나 추가합시다.

2. 그 버튼 누르면 그냥 채팅방 게시물을 하나 DB에 저장해주면 끝입니다. chatroom 컬렉션 하나 만들어서 거기 넣으십시오.

3. 채팅방 게시물 document 하나 안에 들어갈 정보는 하단과 같습니다.

```
(DB에 저장될 채팅방 게시물 document 모습)

{
  member : [채팅당한 유저의 _id, 채팅건 유저의 _id],
  date : 지금날짜,
  title : 채팅방이름(아무거나)
}
```

그래서 로그인하고 글들 옆에 있는 채팅버튼을 누르면

![https://codingapple.com/wp-content/uploads/2021/10/%EC%BA%A1%EC%B2%986-1.png](https://codingapple.com/wp-content/uploads/2021/10/%EC%BA%A1%EC%B2%986-1.png)

▲ 게시물 하나가 chatroom collection 안에 생기면 숙제 성공입니다.

(팁1) list페이지 게시물에 발행한 사람의 _id가 어딘가에 기록이 되어있어야 편리합니다. (저번시간에 구현한듯)

(팁2) 어떤 내용들은 ejs 파일에서 전송할 필요는 없습니다. date, title, 채팅건 유저의 _id 이런건 서버에서 만들어주는게 편할 수 있습니다.

(팁3) 채팅방 게시물의 _id는 ObjectId() 어쩌구로 자동생성되게 냅둡시다.

(팁4) 날짜는 new Date() 라고 쓰면 날짜 나옵니다. 그거 바로 저장하면 됩니다.

알아서 숙제로 해옵시다.

남의 코드 따라치면 남의 코드 따라치기 실력이 늘고

혼자 코드짜보면 혼자 코드짜는 실력이 늡니다.

그래서 숙제가 하나 더 있는데

**(숙제2) 유저가 /chat으로 접속하면 chat.ejs 파일을 보내줘야합니다.**

그리고 그 안엔 내가 속한 채팅방 게시물들을 보여주면 됩니다.

1. 누가 /chat 접속하면 chat.ejs 파일 보내주면 되는데

2. 지금 로그인한 내 _id가 들어있는 채팅방 게시물들을 찾아서

3. ejs 파일에 꽂아서 보내주면 됩니다.

(팁1) 내가 속한 채팅방 게시물은 member : [ ] 안에 내 유저 _id 가 저장된 게시물을 뜻하겠군요.

.find({ member : 요청.user._id }) 이렇게 찾으면 [ ] 안에 있는 정보들도 찾을 수 있습니다.

**chat.ejs 이쁘게 만들고 싶으면**

채팅페이지스러운 html css 는 미리 짜드립니다 필요하면 사용합시다.

(Bootstrap 4 필요)

# node.js,mongoDB 3-17 ****유저간 채팅기능 만들기 2. 채팅방 숙제****

**0:00 저번시간 숙제1**

**10:30 저장시 ObjectId 안에 담고싶으면**

**11:57 저번시간 숙제2**

**18:44 다음시간 메세지 발행할건데 직접 해보셈**

이제 점점 자바스크립트 문법이 중요해지기 시작합니다.

갈수록 자바스크립트 기초가 흔들흔들하다면 자바스크립트 기초 내용 학습이 먼저입니다.

아무튼 숙제나 같이 해봅시다.

일단 숙제하기 전에 저는 유저 계정을 3명 정도 만들어놓고 시작했습니다.

- me, kim, park 이름으로 유저를 만들었고
- kim, park 이름으로 게시물을 하나씩 발행해놨습니다. (게시물엔 작성자 _id가 잘 기록되어있습니다)

이제 me 라는 계정으로 로그인해서 kim, park에게 채팅을 걸어볼 겁니다.

**(숙제1) /list페이지 글 옆의 버튼을 누르면 채팅방 게시물을 발행해보십시오.**

**어떻게 했냐면**

(list.ejs)

```
<div class="container">
    <ul class="list-group">
      <% for (var i=0; i < posts.length ; i++){ %>
        <li class="list-group-item">
          <p>글번호 : <%= posts[i]._id %></p>
          <h4>할일 제목 : <%= posts[i].제목 %></h4>
          <p>할일 마감날짜 : <%= posts[i].날짜 %></p>
          <button class="btn btn-danger delete" data-id="<%= posts[i]._id %>">삭제</button>
          <button class="btn btn-secondary chat" data-id="<%= posts[i].작성자 %>">채팅하기</button></li>
        <% } %>
    </ul>
</div>

<script>
    $('.chat').click(function(e){
      var _id = e.target.dataset.id;
      $.post('/chatroom', {당한사람id : _id})
      .then(()=>{
        console.log('채팅방 게시물 생성완료')
      })
    });
</script>
```

1. list.ejs 파일엔 작성자 정보가 숨겨진 버튼을 추가했습니다.

2. 그 버튼 누르면 post 요청을 보내달라고 코드 짜놨습니다. (ajax post 요청 쉽게하려면 $.post 써도 됩니다)

3. post 요청시 현재 글 작성한 유저의 _id까지 실어서 보냅니다. 필요할 것 같아서요

그럼 이제 서버는 post 요청 받으면 채팅방 게시물 하나 발행해주면 됩니다.

(server.js)

```
app.post('/chatroom', function(요청, 응답){

  var 저장할거 = {
    title : '무슨무슨채팅방',
    member : [ObjectId(요청.body.당한사람id), 요청.user._id],
    date : new Date()
  }

  db.collection('chatroom').insertOne(저장할거).then(function(결과){
    응답.send('저장완료')
  });
});
```

1. 서버는 /chatroom으로 post 요청을 받으면

2. 저런 데이터를 이쁘게 만들어줍니다. 저는 채팅당한사람, 현재 로그인한 사람의 _id 들은 [ ] 안에 담았습니다.

- [ ]  싫으면 다르게 저장하셔도 됩니다.

3. 날짜는 new Date() 하면 나옵니다. 그거 저장하면 됩니다.

4. 저장 완료하면 '저장완료' 메세지를 보내줍니다. 추가로 에러체크 같은 것도 해줄 수 있겠군요.

참고로 db에 insert, find, delete 이런거 하고 콜백함수 대신 .then() 붙일 수 있습니다.

깔끔해보인다면 이렇게 합시다. 에러는 .catch() 붙이면 됩니다.

[collapse]

**(숙제2) 유저가 /chat으로 접속하면 chat.ejs 파일을 보내줘야합니다.**

근데 ejs 파일 안엔 내 유저_id 가 있는 채팅방 게시물들을 다 보여줘야합니다.

**어떻게 했냐면**

(server.js)

```
app.get('/chat', 로그인했니, function(요청, 응답){

  db.collection('chatroom').find({ member : 요청.user._id }).toArray().then((결과)=>{
    console.log(결과);
    응답.render('chat.ejs', {data : 결과})
  })

});
```

1. 서버는 /chat으로 접속하면 chat.ejs 만든거 보내달라고 했습니다.

근데 ejs 파일 안에 내가 속한 채팅방 게시물들이 들어가야합니다.

2. 내가 속한 게시물을 전부 찾으라고 find() 이런걸 썼습니다. [ ] 안에 있는 것들도 그냥 저렇게 찾을 수 있습니다.

찾은 결과는 **응답.render('chat.ejs', {data : 결과})** 이렇게 보냈습니다.

(chat.ejs)

```
<ul class="list-group chat-list">

  <% for (var i=0; i < data.length ; i++){ %>
    <li class="list-group-item" data-id="<%= data[i]._id %>">
      <h6> <%= data[i].title %> </h6>
      <h6 class="text-small"> <%= data[i].member[0] %> </h6>
    </li>
  <% } %>

  <li class="list-group-item">
    <h6>채팅방1</h6>
    <h6 class="text-small">채팅방아이디</h6>
  </li>

</ul>
```

1. chat.ejs는 저번강의의 html css 코드 그대로 복붙했는데

2. 중간에 채팅방 리스트 부분만 저렇게 ejs 문법으로 반복문을 추가했다고 합니다.

그럼 이제 내가 속한 채팅방들을 <li>로 보여줍니다.

[collapse]

다 됐으면 다음시간에 채팅메세지 보내는 기능을 만들어볼겁니다.

메세지 보내는 기능도 그냥 게시물 발행입니다.

근데 댓글처럼 부모 게시물만 기록해주면 끝입니다.

그냥 다음강의 누르기 전에 직접 해보셔도 될듯요